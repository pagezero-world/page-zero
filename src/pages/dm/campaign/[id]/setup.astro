---
export const prerender = false;
import BaseLayout from "../../../../layouts/BaseLayout.astro";
const { id } = Astro.params;
---
<BaseLayout title="DM • Setup">
  <section class="page-block">
    <h1>Setup</h1>
    <p>Configure basics for this adventure.</p>

    <form class="stack" onsubmit="return false;">
      <label class="stack">
        <span>Campaign Title</span>
        <input id="titleInput" type="text" class="box" placeholder="The Shattered Coast" />
      </label>

      <label class="stack">
        <span>Summary</span>
        <textarea id="summaryInput" rows="5" class="box" placeholder="One‑line hook, tone, safety tools…"></textarea>
      </label>

      <button id="saveBtn" class="btn-outline">Save Changes</button>
    </form>
  </section>

  <script type="module" define:vars={{ id }}>
    import { dbPromise } from "../../../../lib/firebase/client.js";
    import { doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const titleEl = document.getElementById("titleInput");
    const summaryEl = document.getElementById("summaryInput");
    const saveBtn = document.getElementById("saveBtn");

    (async () => {
      try {
        const db = await dbPromise;
        const ref = doc(db, "campaigns", id);
        const snap = await getDoc(ref);
        if (snap.exists()) {
          const d = snap.data();
          titleEl.value = d?.title || "";
          summaryEl.value = d?.summary || "";
        }
      } catch (e) {
        console.warn("Load failed:", e);
      }
    })();

    saveBtn?.addEventListener("click", async () => {
      try {
        const db = await dbPromise;
        const ref = doc(db, "campaigns", id);
        await setDoc(ref, {
          title: titleEl.value.trim(),
          summary: summaryEl.value.trim(),
          updatedAt: serverTimestamp()
        }, { merge: true });
        alert("Saved!");
      } catch (e) {
        console.error(e);
        alert("Could not save. Check permissions.");
      }
    });
  </script>
</BaseLayout>
