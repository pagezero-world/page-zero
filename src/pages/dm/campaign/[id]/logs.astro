---
export const prerender = false;
import BaseLayout from "../../../../layouts/BaseLayout.astro";
const { id } = Astro.params;
---
<BaseLayout title="DM â€¢ Logs">
  <section class="page-block">
    <h1>Logs</h1>
    <p>Session summaries and DM notes.</p>

    <form class="stack" onsubmit="return false;">
      <label class="stack">
        <span>New Entry</span>
        <textarea id="logText" rows="5" class="box" placeholder="What happened this session?"></textarea>
      </label>
      <button id="addLog" class="btn-outline">Add Entry</button>
    </form>

    <div class="page-block">
      <h2>Entries</h2>
      <ul id="logList" class="stack"></ul>
    </div>
  </section>

  <script type="module" define:vars={{ id }}>
    import { dbPromise } from "../../../../lib/firebase/client.js";
    import { collection, addDoc, query, where, orderBy, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const textEl = document.getElementById("logText");
    const addBtn = document.getElementById("addLog");
    const listEl = document.getElementById("logList");

    async function load() {
      listEl.innerHTML = "";
      try {
        const db = await dbPromise;
        const col = collection(db, "logs");
        const q = query(col, where("campaignId", "==", id), orderBy("createdAt", "desc"));
        const snap = await getDocs(q);
        if (snap.empty) {
          const li = document.createElement("li");
          li.className = "box";
          li.textContent = "No entries yet.";
          listEl.appendChild(li);
        } else {
          snap.forEach(doc => {
            const d = doc.data();
            const li = document.createElement("li");
            li.className = "box";
            const t = new Date(d?.createdAt?.toDate?.() || Date.now()).toLocaleString();
            li.textContent = `[${t}] ${d?.text || ""}`;
            listEl.appendChild(li);
          });
        }
      } catch (e) {
        console.warn("Load logs failed:", e);
      }
    }

    addBtn?.addEventListener("click", async () => {
      const text = textEl.value.trim();
      if (!text) return alert("Write something first.");
      try {
        const db = await dbPromise;
        await addDoc(collection(db, "logs"), {
          campaignId: id,
          text,
          createdAt: serverTimestamp()
        });
        textEl.value = "";
        await load();
      } catch (e) {
        console.error(e);
        alert("Could not add log.");
      }
    });

    load();
  </script>
</BaseLayout>
