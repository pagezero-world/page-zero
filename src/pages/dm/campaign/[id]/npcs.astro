---
export const prerender = false;
import BaseLayout from "../../../../layouts/BaseLayout.astro";
const { id } = Astro.params;
---
<BaseLayout title="DM • NPCs">
  <section class="page-block">
    <h1>NPCs</h1>
    <p>Track notable characters and factions.</p>

    <form class="stack" onsubmit="return false;">
      <label class="stack">
        <span>Name</span>
        <input id="npcName" type="text" class="box" placeholder="Captain Mira Thorne" />
      </label>
      <label class="stack">
        <span>Blurb</span>
        <textarea id="npcBlurb" rows="3" class="box" placeholder="One‑sentence hook or role."></textarea>
      </label>
      <button id="addNpc" class="btn-outline">Add NPC</button>
    </form>

    <div class="page-block">
      <h2>NPC List</h2>
      <ul id="npcList" class="stack"></ul>
    </div>
  </section>

  <script type="module" define:vars={{ id }}>
    import { dbPromise } from "../../../../lib/firebase/client.js";
    import { collection, addDoc, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const nameEl = document.getElementById("npcName");
    const blurbEl = document.getElementById("npcBlurb");
    const addBtn = document.getElementById("addNpc");
    const listEl = document.getElementById("npcList");

    async function load() {
      listEl.innerHTML = "";
      try {
        const db = await dbPromise;
        const col = collection(db, "npcs");
        const q = query(col, where("campaignId", "==", id));
        const snap = await getDocs(q);
        snap.forEach(doc => {
          const d = doc.data();
          const li = document.createElement("li");
          li.className = "box";
          li.textContent = `${d?.name || "Unnamed"} — ${d?.blurb || ""}`;
          listEl.appendChild(li);
        });
      } catch (e) {
        console.warn("Load NPCs failed:", e);
      }
    }

    addBtn?.addEventListener("click", async () => {
      const name = nameEl.value.trim();
      if (!name) return alert("Give your NPC a name.");
      try {
        const db = await dbPromise;
        await addDoc(collection(db, "npcs"), {
          campaignId: id,
          name,
          blurb: blurbEl.value.trim(),
          createdAt: serverTimestamp()
        });
        nameEl.value = "";
        blurbEl.value = "";
        await load();
      } catch (e) {
        console.error(e);
        alert("Could not add NPC.");
      }
    });

    load();
  </script>
</BaseLayout>
